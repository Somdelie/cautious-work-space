generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Supplier {
  id               String            @id @default(cuid())
  name             String            @unique
  logoUrl          String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  supplierProducts SupplierProduct[]
  jobs             Job[]
  orderItems       OrderItem[]
}

model Manager {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  jobs      Job[]
}

model User {
  id                     String    @id @default(cuid())
  name                   String
  phone                  String
  email                  String    @unique
  password               String
  role                   String    @default("user")
  blocked                Boolean   @default(false)
  passwordResetCodeHash  String?
  passwordResetExpiresAt DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @default(now()) @updatedAt

  timesheetEntries TimesheetEntry[]
}

// from Product model. Consolidated OrderItem model.
model Product {
  id        String    @id @default(cuid())
  name      String    @unique
  shortcut  String?
  usageType UsageType @default(BOTH)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  jobProducts      JobProduct[]
  supplierProducts SupplierProduct[]
  orderItems       OrderItem[]
  spreadRates      SpreadRate[]
}

// Junction table for many-to-many relationship between Supplier and Product
model SupplierProduct {
  supplierId String
  productId  String
  isActive   Boolean          @default(true)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @default(now()) @updatedAt
  variants   ProductVariant[]
  product    Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier   Supplier         @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@id([supplierId, productId])
  @@index([productId])
}

model ProductVariant {
  id              String          @id @default(cuid())
  size            Float
  unit            MeasureUnit
  price           Decimal         @default(0) @db.Decimal(12, 2)
  sku             String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt
  productId       String
  supplierId      String
  orderItems      OrderItem[]
  supplierProduct SupplierProduct @relation(fields: [supplierId, productId], references: [supplierId, productId], onDelete: Cascade)
  jobProducts     JobProduct[]

  @@unique([supplierId, productId, size, unit])
}

model SpreadRate {
  id          String      @id @default(cuid())
  consumption Float
  unit        MeasureUnit
  perCoat     Boolean     @default(false)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt
  productId   String
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Job {
  id        String @id @default(cuid())
  jobNumber String @unique

  // ✅ your UI expects these names
  siteName String
  client   String?
  address  String?

  managerId  String?
  supplierId String?

  source JobSource @default(APP)

  // ✅ attachments for spec/boq only (urls optional)
  specPdfUrl String?
  boqPdfUrl  String?

  // ✅ "not required" flags (job-level)
  specNotRequired       Boolean @default(false)
  boqNotRequired        Boolean @default(false)
  safetyFileNotRequired Boolean @default(false)

  // ✅ safety file is boolean received (NO URL)
  safetyFile Boolean @default(false)

  // ✅ you already use this in JobsDataTable
  specsReceived Boolean @default(false)

  // ✅ keep if you use them (your actions have these)
  isStarted  Boolean   @default(false)
  isFinished Boolean   @default(false)
  startedAt  DateTime?
  finishedAt DateTime?

  // For Excel sync
  importedAt        DateTime  @default(now())
  excelFileName     String?
  excelSheetName    String?
  excelRowRef       String?
  dateRequested     DateTime?
  finishingSchedule String?
  loa               String?
  pointers          String?
  managerNameRaw    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  manager  Manager?  @relation(fields: [managerId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  jobProducts JobProduct[]
  orders      Order[]

  timesheetEntries TimesheetEntry[]
  jobCostEntries   JobCostEntry[]
  jobCostSummaries JobCostSummary[]
}

// Junction table for many-to-many relationship between Job and Product
model JobProduct {
  id        String  @id @default(cuid())
  jobId     String
  productId String
  required  Boolean @default(false)

  quantity Decimal? @db.Decimal(12, 2)
  unit     String?

  // ✅ estimate selection (professional)
  estimateVariantId String?
  estimateUnitPrice Decimal? @db.Decimal(12, 2) // snapshot of variant.price at time selected

  job             Job             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  estimateVariant ProductVariant? @relation(fields: [estimateVariantId], references: [id], onDelete: SetNull)

  @@unique([jobId, productId])
  @@index([estimateVariantId])
}

// Consolidated Order and OrderItem models
model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  jobId       String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt
  subtotal    Decimal     @default(0) @db.Decimal(12, 2)
  job         Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  items       OrderItem[]

  @@unique([orderNumber, jobId])
}

// Consolidated OrderItem model
model OrderItem {
  id         String         @id @default(cuid())
  orderId    String
  quantity   Decimal        @db.Decimal(12, 2)
  createdAt  DateTime       @default(now())
  lineTotal  Decimal        @db.Decimal(12, 2)
  unitPrice  Decimal        @db.Decimal(12, 2)
  variantId  String
  productId  String
  supplierId String
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product        @relation(fields: [productId], references: [id])
  supplier   Supplier       @relation(fields: [supplierId], references: [id])
  variant    ProductVariant @relation(fields: [variantId], references: [id])

  @@index([productId])
  @@index([supplierId])
}

// Enums used in the schema
enum UsageType {
  INTERNAL
  EXTERNAL
  BOTH
}

// Units of measurement for product variants and spread rates
enum MeasureUnit {
  L
  KG
  EA
}

// Source of the job creation
enum JobSource {
  APP
  EXCEL
}

// Additional enums for future use
enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

// Additional enums for future use
enum JobCostType {
  MATERIAL_ACTUAL
  MATERIAL_ESTIMATE
  LABOR_ACTUAL
  ADJUSTMENT
}

// Additional enums for future use
enum JobCostSource {
  ORDER_ITEM
  JOB_PRODUCT
  TIMESHEET
  MANUAL
}

// New model for job cost entries
model JobCostEntry {
  id        String        @id @default(cuid())
  jobId     String
  type      JobCostType
  source    JobCostSource
  sourceId  String?
  amount    Decimal       @db.Decimal(12, 2) // + add, - subtract
  note      String?
  createdAt DateTime      @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, type])
  @@index([source, sourceId])
  @@index([createdAt])
}

// New model for job cost summaries
model JobCostSummary {
  jobId String @id

  materialsActual   Decimal @default(0) @db.Decimal(12, 2)
  materialsEstimate Decimal @default(0) @db.Decimal(12, 2)
  laborActual       Decimal @default(0) @db.Decimal(12, 2)

  totalActual   Decimal @default(0) @db.Decimal(12, 2)
  totalEstimate Decimal @default(0) @db.Decimal(12, 2)

  updatedAt DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

// New model for timesheet entries
model TimesheetEntry {
  id         String          @id @default(cuid())
  jobId      String
  workerName String
  date       DateTime
  hours      Decimal         @db.Decimal(6, 2)
  rate       Decimal         @db.Decimal(12, 2)
  cost       Decimal         @default(0) @db.Decimal(12, 2)
  status     TimesheetStatus @default(PENDING)
  note       String?

  approvedAt DateTime?
  approvedBy String? // User.id (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job      Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  approver User? @relation(fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([jobId, date])
  @@index([status])
}
