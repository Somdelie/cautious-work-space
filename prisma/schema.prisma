generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//
// =========================
// ENUMS
// =========================
//

enum UsageType {
  INTERNAL
  EXTERNAL
  BOTH
}

enum JobSource {
  APP
  EXCEL
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobCostType {
  MATERIAL_ACTUAL
  MATERIAL_ESTIMATE
  LABOR_ACTUAL
  ADJUSTMENT
}

enum JobCostSource {
  ORDER_ITEM
  JOB_PRODUCT
  TIMESHEET
  MANUAL
}

//
// =========================
// AUTH & USERS
// =========================
//

model User {
  id                     String    @id @default(cuid())
  name                   String
  phone                  String
  email                  String    @unique
  password               String
  role                   String    @default("user")
  blocked                Boolean   @default(false)
  passwordResetCodeHash  String?
  passwordResetExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  timesheetEntries TimesheetEntry[]
}

//
// =========================
// PEOPLE / ORG
// =========================
//

model Manager {
  id    String  @id @default(cuid())
  name  String
  phone String?
  email String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  jobs Job[]
}

model Supplier {
  id      String  @id @default(cuid())
  name    String  @unique
  logoUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  supplierProducts      SupplierProduct[]
  supplierVariantPrices SupplierVariantPrice[]
  jobs                  Job[]
  orderItems            OrderItem[]
}

//
// =========================
// CATALOG (GLOBAL)
// =========================
//

model Product {
  id        String    @id @default(cuid())
  name      String    @unique
  shortcut  String?
  usageType UsageType @default(BOTH)

  unitId    String
  unit      Unit      @relation(fields: [unitId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discountPrice         Decimal?               @db.Decimal(12, 2)
  // Relations
  productOptions        ProductOption[]
  supplierProducts      SupplierProduct[]
  supplierVariantPrices SupplierVariantPrice[]
  jobProducts           JobProduct[]
  orderItems            OrderItem[]
  spreadRates           SpreadRate[]
}

/**
 * Unit is global, configurable (MM, L, KG, EA, ROLL, PACK, etc).
 */
model Unit {
  id   String @id @default(cuid())
  code String @unique // "MM", "L", "KG", "EA", "ROLL", "PACK"
  name String // "Millimeter", "Liter", "Kilogram", "Each"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  options     ProductVariantOption[]
  spreadRates SpreadRate[]
  products    Product[]
}

/**
 * ProductVariantOption is global: "24 + MM", "5 + L", etc.
 * Re-used by many products.
 */
model ProductVariantOption {
  id     String  @id @default(cuid())
  value  Float
  unitId String
  label  String? // optional: "24mm", "5L" (display)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unit           Unit            @relation(fields: [unitId], references: [id], onDelete: Restrict)
  productOptions ProductOption[]

  @@unique([value, unitId]) // one option per value+unit globally
  @@index([unitId])
}

/**
 * ProductOption attaches options to a product.
 * Example: Masking Tape -> 24mm, 36mm, 48mm.
 */
model ProductOption {
  id        String  @id @default(cuid())
  productId String
  optionId  String
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  option  ProductVariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  prices      SupplierVariantPrice[]
  orderItems  OrderItem[]
  jobProducts JobProduct[]

  @@unique([productId, optionId])
  @@index([productId])
  @@index([optionId])
}

/**
 * Optional: supplier/product association (enable/disable product per supplier).
 * Keep if your business needs it.
 */
model SupplierProduct {
  supplierId String
  productId  String
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([supplierId, productId])
  @@index([productId])
}

/**
 * Supplier-specific pricing for a product option.
 * Example: Supplier A sells Masking Tape 24mm at R28.
 */
model SupplierVariantPrice {
  id              String @id @default(cuid())
  supplierId      String
  productId       String
  productOptionId String

  price    Decimal @default(0) @db.Decimal(12, 2)
  sku      String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier      Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  productOption ProductOption @relation(fields: [productOptionId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productOptionId]) // one price per supplier per productOption
  @@index([supplierId])
  @@index([productId])
  @@index([productOptionId])
}

model SpreadRate {
  id          String  @id @default(cuid())
  consumption Float
  unitId      String
  perCoat     Boolean @default(false)
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Restrict)

  @@index([productId])
  @@index([unitId])
}

//
// =========================
// JOBS
// =========================
//

model Job {
  id        String @id @default(cuid())
  jobNumber String @unique

  siteName String
  client   String?
  address  String?

  managerId  String?
  supplierId String?

  source JobSource @default(APP)

  // attachments
  specPdfUrl String?
  boqPdfUrl  String?

  // not required flags
  specNotRequired       Boolean @default(false)
  boqNotRequired        Boolean @default(false)
  safetyFileNotRequired Boolean @default(false)

  // received boolean
  safetyFile    Boolean @default(false)
  specsReceived Boolean @default(false)

  // status
  isStarted  Boolean   @default(false)
  isFinished Boolean   @default(false)
  startedAt  DateTime?
  finishedAt DateTime?

  // Excel sync metadata
  importedAt        DateTime  @default(now())
  excelFileName     String?
  excelSheetName    String?
  excelRowRef       String?
  dateRequested     DateTime?
  finishingSchedule String?
  loa               String?
  pointers          String?
  managerNameRaw    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  manager  Manager?  @relation(fields: [managerId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  jobProducts      JobProduct[]
  orders           Order[]
  timesheetEntries TimesheetEntry[]
  jobCostEntries   JobCostEntry[]
  jobCostSummary   JobCostSummary?
}

model JobProduct {
  id        String  @id @default(cuid())
  jobId     String
  productId String
  required  Boolean @default(false)

  quantity Decimal? @db.Decimal(12, 2)
  unit     String?

  // estimate option selection (global option attached to product)
  estimateProductOptionId String?
  estimateUnitPrice       Decimal? @db.Decimal(12, 2) // snapshot at time selected

  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  estimateProductOption ProductOption? @relation(fields: [estimateProductOptionId], references: [id], onDelete: SetNull)

  @@unique([jobId, productId])
  @@index([estimateProductOptionId])
}

//
// =========================
// ORDERS
// =========================
//

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique
  jobId       String

  subtotal Decimal @default(0) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  job   Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@unique([orderNumber, jobId])
  @@index([jobId])
}

model OrderItem {
  id         String @id @default(cuid())
  orderId    String
  productId  String
  supplierId String

  // the chosen option for this product (24mm etc)
  productOptionId String

  quantity  Decimal @db.Decimal(12, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])
  supplier      Supplier      @relation(fields: [supplierId], references: [id])
  productOption ProductOption @relation(fields: [productOptionId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([supplierId])
  @@index([productOptionId])
}

//
// =========================
// TIMESHEETS (LABOR)
// =========================
//

model TimesheetEntry {
  id         String   @id @default(cuid())
  jobId      String
  workerName String
  date       DateTime

  hours Decimal @db.Decimal(6, 2)
  rate  Decimal @db.Decimal(12, 2)
  cost  Decimal @default(0) @db.Decimal(12, 2)

  status TimesheetStatus @default(PENDING)
  note   String?

  approvedAt DateTime?
  approvedBy String? // User.id (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job      Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  approver User? @relation(fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([jobId, date])
  @@index([status])
  @@index([approvedBy])
}

//
// =========================
// COST LEDGER + SUMMARY
// =========================
//

model JobCostEntry {
  id        String        @id @default(cuid())
  jobId     String
  type      JobCostType
  source    JobCostSource
  sourceId  String?
  amount    Decimal       @db.Decimal(12, 2) // + add, - subtract
  note      String?
  createdAt DateTime      @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, type])
  @@index([source, sourceId])
  @@index([createdAt])
}

model JobCostSummary {
  jobId String @id

  materialsActual   Decimal @default(0) @db.Decimal(12, 2)
  materialsEstimate Decimal @default(0) @db.Decimal(12, 2)
  laborActual       Decimal @default(0) @db.Decimal(12, 2)

  totalActual   Decimal @default(0) @db.Decimal(12, 2)
  totalEstimate Decimal @default(0) @db.Decimal(12, 2)

  updatedAt DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
}
