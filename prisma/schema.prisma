generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UsageType {
  INTERNAL
  EXTERNAL
  BOTH
}

enum MeasureUnit {
  L
  KG
  EA
}

enum JobSource {
  APP
  EXCEL
}

model User {
  id       String  @id @default(cuid())
  name     String
  phone    String
  email    String  @unique
  password String
  role     String  @default("user")
  blocked  Boolean @default(false)

  passwordResetCodeHash  String?
  passwordResetExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Manager {
  id    String  @id @default(cuid())
  name  String
  phone String?
  email String?

  jobs Job[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Supplier {
  id      String  @id @default(cuid())
  name    String  @unique
  logoUrl String?

  supplierProducts SupplierProduct[]
  jobs             Job[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  orderItems OrderItem[]
}

model Product {
  id        String    @id @default(cuid())
  name      String    @unique
  shortcut  String?
  usageType UsageType @default(BOTH)

  supplierProducts SupplierProduct[]
  spreadRates      SpreadRate[]

  jobProducts JobProduct[]
  orderItems  OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model SupplierProduct {
  supplierId String
  productId  String

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  variants ProductVariant[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@id([supplierId, productId]) // composite id keeps it unique naturally
  @@index([productId])
}

model ProductVariant {
  id              String          @id @default(cuid())
  supplierId      String
  productId       String
  supplierProduct SupplierProduct @relation(fields: [supplierId, productId], references: [supplierId, productId], onDelete: Cascade)

  size     Float
  unit     MeasureUnit
  price    Float       @default(0)
  sku      String?
  isActive Boolean     @default(true)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @default(now()) @updatedAt
  orderItems OrderItem[]

  @@unique([supplierId, productId, size, unit])
}

model SpreadRate {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Always store as "units per mÂ²"
  consumption Float
  unit        MeasureUnit
  perCoat     Boolean     @default(false)
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([productId])
}

model Job {
  id        String  @id @default(cuid())
  jobNumber String  @unique
  siteName  String
  client    String?

  source         JobSource @default(APP)
  importedAt     DateTime?
  excelFileName  String?
  excelSheetName String?
  excelRowRef    String?

  managerNameRaw String?

  managerId  String?
  supplierId String?

  manager  Manager?  @relation(fields: [managerId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  specPdfUrl String?
  boqPdfUrl  String?

  jobProducts JobProduct[]
  orders      Order[]

  isStarted  Boolean   @default(false)
  isFinished Boolean   @default(false)
  startedAt  DateTime?
  finishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model JobProduct {
  id        String @id @default(cuid())
  jobId     String
  productId String

  required Boolean @default(false)
  quantity Float?
  unit     String?

  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([jobId, productId])
}

model Order {
  id          String @id @default(cuid())
  orderNumber String
  jobId       String
  job         Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  items OrderItem[]

  subtotal Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([orderNumber, jobId])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // what was ordered
  productId String
  product   Product @relation(fields: [productId], references: [id])

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity  Float // number of packs
  unitPrice Float // snapshot
  lineTotal Float // snapshot

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([supplierId])
}
